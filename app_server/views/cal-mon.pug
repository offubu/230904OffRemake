extends layout

block content
  div(class='modal fade', id="postModal", tabindex="-1", role="dialog", aria-labelledby="exampleModalLabel" aria-hidden="true")
    div(class="modal-dialog modal-lg", role="document")
      div(class="modal-content")
        .row(style={margin:'0',padding:"10px 10px"}).banner
          .col-12
            h5.float-right (Esc to exit)
            h1 Form for Adding a Single Activity
        .row(style={margin:'0',padding:"10px 10px"})
          .col-12
            form(action=`/api/years/${year}/${fortnight}/intent`, method="post", role="form")
              .form-group.row
                label.col-2.col-form-label(for="agroup") Activity Type
                .col-4
                  select#agroup.form-control.input-sm(name="agroup")
                    option Physical Activity Intent
                    option General Activity Intent
                    option Expected Routine Activity
              .form-group.row
                label.col-2.col-form-label(for="name") Name
                .col-4
                  input#name.form-control(name="name")
                label.col-2.col-form-label(for="acode") Activity Code
                .col-4
                  select#acode.form-control.input-sm(name="acode")
                    option 1000(No Activity)
                    option 1001(Walking)
                    option 1002(Running)
                    option 9001(Pilates)
                    option 9002(Yoga)

              .form-group.row
                label.col-2.col-form-label(for="begin") Begin
                .col-4
                  input#begin(type="datetime-local" name="begin").form-control
                label.col-2.col-form-label(for="end") End
                .col-4
                  input#end(type="datetime-local" name="end").form-control
                
              .form-group.row
                .col-10
                .col-2
                  input#add(type="submit" name="add" value="Add Activity").float-right
  
  div(class='modal fade', id="getModal", tabindex="-1", role="dialog", aria-labelledby="exampleModalLabel" aria-hidden="true")
    div(class="modal-dialog modal-lg", role="document")
      div(class="modal-content")
        .row(style={margin:'0',padding:"10px 10px"}).banner
          .col-12
            h5.float-right (Esc to exit)
            h1 Activity Info

  div(class='modal fade', id="activeTimesPutModal", tabindex="-1", role="dialog", aria-labelledby="exampleModalLabel" aria-hidden="true")
    div(class="modal-dialog modal-lg", role="document")
      div(class="modal-content")
        .row(style={margin:'0',padding:"10px 10px"}).banner
          .col-12
            h5.float-right (Esc to exit)
            h1 Change Active Times (Overflowing Activities will be preserved)

  .row.banner
    .col-12
      h1 #{fortnight}th Fortnight of 2029 Calendar
      h3  
        small &nbsp;Fit user activities around the perception of their fatigue based on discussion and validations of their based opinions.
  .row
    .col-md-6
      .card.card-primary(style={opacity:0.5})
          .card-block
            h2.card-title#rulid Toggle Rule Header if Desired
            .card-header
              p.lead Rule inference for adherentWhoAdherence, with ont-ised citation and rule inference for other requirements using verified API
              p  
                br
                | shP2hasType[?P,?adherentWhoAdherence]:- 
                br
                | &emsp; sh:E21Person[?P],
                br 
                | &emsp; sh:FW44PhysicalActivity[?PA],
                br 
                | &emsp; sh:FW41CarriedOutBy[?PA,?P], ...
          button(type="button" onClick="jbutton()") jbutton
            script(src='/javascripts/jquery.js')

  .row  
    .col-12.col-md-6
      p.rating
          i.fas.fa-star
          i.fas.fa-star
          i.fas.fa-star
          i.far.fa-star
          i.far.fa-star
      p Current Adherence over 4 Fortnights is : Adherent
  
  .row
    .col-12
      .card.card-primary
        .card-body
          h2 Calendar / Timeslots 
        .card-block.card-body 
          p Show the named times of day as columns with rows of specific periods. Hovering over the periods shows the allocation and a "change" button, clicking on them could expose a sidebar or header with citations.
          br
          table
            tbody 
              tr 
                td
                  input(type="datetime-local", name="")
                td
                  a.btn.btn-primary.float-right(href=`/years/${year}/${fortnight}/activity-form`) Schedule a single activity Form
                td 
                  button.btn.btn-primary.float-right('data-toggle'='modal', 'data-target'='#postModal') Schedule a single activity Modal      
          
        .card-block.card-header
          .row
            .col-2
              .card-body.card-header(style={'text-align':'center',padding:'2px 0 2px 0','margin':'0px 0.5px 0px 0.5px'})
                  p.card-header Day
              -for(let d=1;d<15;d++)
                .card-body.card-header(style={'text-align':'center',padding:'1.9px 0 1.9px 0','margin':'0 1px 0 1px'})
                  .card-header(style={'margin':'0px 1px 0px 1px'}) 
                    p #{d} day
            .col-10
              .sticky-xhead-ymarg-scroll-window
                .ca-days-hours-table(style={'padding-left':'15px'})
                  .row
                    - for(let i=1;i<=12;i++)
                      .card-body.card-header.col-1(style={'text-align':'center',padding:'1px 0 1px 0'})
                        .row(style={'margin-right':'0','margin-left':'0'})
                          .col-6(style={padding:'0'})
                            p.card-header(style={'margin':'0px 1px 0px 1px'}) #{i*2-1}
                          .col-6(style={padding:'0'})
                            p.card-header(style={'margin':'0px 1px 0px 1px'}) #{i*2}
                  - for(let d=1;d<=14;d++)
                    .row(style={height:'34.9px','margin-bottom':'0'})
                      - for(let g=1;g<=12;g++)
                        .card-body.card-header.col-1(style={'text-align':'center',padding:'2px 0 2px 0'})
                          .row(style={padding:'0 0 0 0','margin':'0 0 0 0'})
                            - for(let h=0;h<=1;h++)
                              .col-3(style={padding:'0',margin:'0'}, class="winelcol", id=`c${d}d${g*2-1+h}h00m`)
                                .card-header(style={'margin':'0px 1px 0px 1px',padding:'3px 0 3px 0'})
                                  hr(class="hry", style={height:'2px',background:'yellow',width:'0%',margin:'-3px 0px 0px 70%',padding:'0'})
                                  a(class="winel", id=`${d}d${g*2-1+h}h00m`, style={opacity:'20%',padding:'0',margin:'0'},'data-toggle'='modal', 'data-target'='#postModal') &#10133
                                  hr(class="hrc", style={height:'2px',background:'cyan',width:' 0%',margin:'0px 1px -3px 50%',padding:'0'})
                              .col-3(style={padding:'0',margin:'0'}, class="winelcol", id=`c${d}d${g*2-1+h}h30m`)
                                .card-header(style={'margin':'0px 1px 0px 1px',padding:'3px 0 3px 0'}) 
                                  hr(class="hry",style={height:'2px',background:'yellow',width:'0%',margin:'-3px 1px 0px 0px',padding:'0'})
                                  a(class="winel", id=`${d}d${g*2-1+h}h30m`, style={opacity:'20%',padding:'0',margin:'0'},'data-toggle'='modal', 'data-target'='#postModal') &#10133
                                  hr(class="hrc", style={height:'2px',background:'cyan',width:'0%',margin:'0px 1px -3px 0px',padding:'0'})
          .row 
            .card-body
              .col-2
                .card-header
                  .output 

          script.
            let pageDays  = !{JSON.stringify(days)};

            let bt = document.querySelector("#begin"); 
            let et = document.querySelector("#end"); 
            bt.addEventListener( 'keyup',
              () => {  console.log(bt.value)
                let keyupBtVal = new Date(bt.value); 
                keyupBtVal.setMinutes(keyupBtVal.getMinutes() + 1);
                et.min = keyupBtVal.toISOString().slice(0,16);
              }
            )

            let hryEls = document.getElementsByClassName("hry");
            let hrcEls = document.getElementsByClassName("hrc");
            for(let y=0;y<hryEls.length;y++){ hryEls[y].style.width='10%'; }
            
            //- let wlc = document.getElementsByClassName("winelcol");
            let wl = document.getElementsByClassName("winel");
            for(let w=0;w<wl.length;w++){
              //- let idwwlc = document.getElementById(wl[w].id); console.log('idwwl.id:',idwwl.id);
              let idwwl = document.getElementById(wl[w].id); console.log('idwwl.id:',idwwl.id);
              let idbuf='';let wind=0;let winh=0;let winm=0;
              for(c in idwwl.id){ idbuf+=idwwl.id[c];
                if(idwwl.id[c]=='d'){ wind=parseInt(idbuf); console.log('wind:',wind); idbuf=''; continue; }
                if(idwwl.id[c]=='h'){ winh=parseInt(idbuf); console.log('winh:',winh); idbuf=''; continue; }
                if(idwwl.id[c]=='m'){ winm=parseInt(idbuf); console.log('winm:',winm); idbuf=''; continue; }
              }
              console.log(`days[wind]: `,pageDays[wind-1]);

              idwwl.addEventListener( "click",
                () => {  console.log('clickListener=>outer_scope_idwwl.id:',idwwl.id)                
                  let selectTime = new Date(pageDays[wind-1].date); 
                  selectTime.setHours(winh);
                  selectTime.setMinutes(winm);
                  bt.value = selectTime.toISOString().slice(0,16);
                  selectTime.setMinutes(selectTime.getMinutes() + 1);
                  et.min = selectTime.toISOString().slice(0,16);
                  et.value = selectTime.toISOString().slice(0,16);
                }
              )

              let wdate = new Date(pageDays[wind-1].date);  
              wdate.setHours(winh);  wdate.setMinutes(winm);
              let wdate1 = new Date(wdate);  wdate1.setMinutes(wdate1.getMinutes()+30);
              
              // static5 powderblue
              for(let i=0;i<5;i++){
                let deraBegin = new Date(pageDays[wind-1].expectedRoutineActivities[i].duration.begin)
                let deraEnd = new Date(pageDays[wind-1].expectedRoutineActivities[i].duration.end)
                let deraT = deraEnd.getTime()-deraBegin.getTime();
                if(deraT>3600000) console.log('over 1hr, 30 min intervals');
                let deraIntervals = [];
                let dIN = Math.ceil(deraT/1800000) - 2;


                console.log(
                  'wdate',wdate.toISOString().slice(0,16),
                  '|| wdate1',wdate1.toISOString().slice(0,16),
                  '|| deraBegin',deraBegin.toISOString().slice(0,16),
                  '|| deraEnd',deraEnd.toISOString().slice(0,16),
                  '|| deraT',deraT,  '|| dIN',dIN
                );

                //- if(dIN==0){
                if(
                  (deraBegin.getTime()>=wdate.getTime() && deraBegin.getTime()<wdate1.getTime())
                  ||
                  (deraEnd.getTime()>=wdate.getTime() && deraEnd.getTime()<wdate1.getTime())
                ){  console.log('style changing');
                  idwwl.style.background='red';  idwwl.style.opacity ='100%';
                  idwwl.innerHTML = '&#128221';
                  idwwl.dataset.target='#getModal'
                }
                //- }
                if(
                  (deraBegin.getTime()>=wdate.getTime() && deraBegin.getTime()<wdate1.getTime())
                ){ let marL = (deraBegin.getMinutes()%30)/30;
                  hryEls[w].style.margin='-3px 0 0 '+marL+'%';  //  LINE GEO FUNCTION
                  if(deraEnd.getTime()>=wdate1.getTime()) hryEls[w].style.width='100%';
                  if(deraEnd.getTime()<wdate1.getTime()) hryEls[w].style.width=`${(deraT%30)/30}%`;
                }

                if(dIN>0){
                  for(let dI=1; dI<=dIN; dI++){  let interval = new Date(deraBegin);
                    interval.setTime(interval.getTime()+dI*1800000);
                    deraIntervals.push(interval);
                  }
                }

                for(let dI=1;dI<=dIN;dI++){
                  if(
                    (deraIntervals[dI-1].getTime()>=wdate.getTime() && deraIntervals[dI-1].getTime()<wdate1.getTime())
                  ){  console.log('style changing');
                    idwwl.style.background='red';  idwwl.style.opacity ='100%';
                    idwwl.innerHTML = '&#128221';
                    idwwl.dataset.target='#getModal'
                    hryEls[w].style.width='100%';  //  LINE GEO FUNCTION
                  }
                }
              }
            }

            const scrollDemo = document.querySelector(".sticky-xhead-ymarg-scroll-window");
            let earlyAmStart = !{testWake}; let scrollX = 2300/24*(earlyAmStart-1.5)
            scrollDemo.scrollTo(scrollX,0)
            const output = document.querySelector(".output");
            scrollDemo.addEventListener( "scroll", 
              event => {
                output.innerHTML = `scrollTop: ${scrollDemo.scrollTop} <br>
                                    scrollLeft: ${scrollDemo.scrollLeft} `;
              }, 
              { passive: true }
            );

            document.body.onload = () => {
              console.log('referrer:',document.referrer,'earlyAmStart: ',`!{fortnight}`,`!{testWake}`)
            }


  .row
    .col-12.col-md-9
      .card.card-primary.review-card
        .card-block
          a.btn.btn-primary.float-right(href='/location/review/new') Add review
          h2.card-title Comments Generated from previous 3 or 4 weeks
          .row.review
            .col-12.no-gutters.review-header
              span.rating
                i.fas.fa-star
                i.fas.fa-star
                i.fas.fa-star
                i.far.fa-star
                i(style={color: 'red'}).far.fa-star
              span.reviewAuthor &nbsp;&nbsp; Fatigue change
              small.reviewTimestamp.float-right  16 February 2017
            .col-12
              p Fatigue went from 2 to 1, maintain rest frequency, vm will likely raise fatigue to 2, increase tea/hydration/hot chocolate. trial admin, group admin and accepted aid/care users can push SLEEP EMOJI here
          .row.review
            .col-12.no-gutters.review-header
              span.rating
                i.fas.fa-star
                i.fas.fa-star
                i.fas.fa-star
                i.far.fa-star
                i.far.fa-star
              span.reviewAuthor &nbsp;&nbsp; FOOD REQUEST
              small.reviewTimestamp.float-right 14 February 2017
            .col-12
              p FOOD diary can post food emojis here. FOOD REQUESTS can also be made.
    .col-12.col-md-3
      .card.card-primary
        .card-body
          h2.card-title Active Times             
        .card-header
          p.card-text Early AM Begin: 
            span.float-right 5:00am
          p.card-text Late PM End : 
            span.float-right 9:30pm

        .card-body.a.btn.btn-primary(href='/location/review/new') Change Your Active Times
      .card.card-primary
        .card-block
          h2.card-title Modes
          .card-header
            span.badge.badge-warning
              i.fa.fa-check
              | &nbsp;InhibitoryControl:2
            | &nbsp;
            span.badge.badge-warning
              i.fa.fa-check
              | &nbsp;Fatigue:1
            | &nbsp;
            span.badge.badge-warning
              i.fa.fa-check
              | &nbsp;PriorityPA:MM
            | &nbsp;


